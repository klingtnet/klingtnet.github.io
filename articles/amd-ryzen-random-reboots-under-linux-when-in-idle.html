<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="description" content="This post describes how to prevent random reboots for AMD Ryzen based Linux systems in idle state that use XMP memory profiles.">
  
  <title>AMD Ryzen random reboots under Linux when in idle</title>

  <link rel="icon" type="image/svg+xml" href='https://klingt.net/assets/logo.svg'>
  <link rel="apple-touch-icon" href='https://klingt.net/assets/logo-apple-touch-icon.png'>

  <link rel="stylesheet" type="text/css" href='https://klingt.net/assets/fonts/FiraCode/fira_code.css' />
  <link rel="stylesheet" type="text/css" href='https://klingt.net/assets/fonts/FiraGO/fira_go.css' />
  <link rel="stylesheet" type="text/css" href='https://klingt.net/assets/base.css' />
  
  <link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.0.1/styles/github.min.css"
    media="screen and (prefers-color-scheme: light)" />
  <link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.0.1/styles/github-dark.min.css"
    media="screen and (prefers-color-scheme: dark)" />
  <script src="//unpkg.com/@highlightjs/cdn-assets@11.0.1/highlight.min.js"></script>
  <script defer>
    hljs.highlightAll();
  </script>
  <script type="text/javascript">new Image().src='https://nullitics.com/n.gif?u=' + encodeURI(location.href) + '&r=' + encodeURI(document.referrer) + '&d=' + screen.width;</script>
</head>

<body>
  <div class="wrapper">
    <div class="header">
      <header>
        
<nav>
  <div class="header-bar">
    <details class="mobile-menu">
      <summary><img class="hamburger nav-icon invert-if-dark" src='https://klingt.net/assets/hamburger.svg'>
      </summary>
      <div class="dropdown sm-margin-top">
        <ul class="nav nobullets">
          
          <li><a class="reset-color" href='https://klingt.net/index.html'>Home</a></li>
          
          <li><a class="reset-color" href='https://klingt.net/articles'>Articles</a></li>
          
          <li><a class="reset-color" href='https://klingt.net/about-me.html'>About Me</a></li>
          
          <li><a class="reset-color" href='https://klingt.net/imprint.html'>Imprint</a></li>
          
          <li><a class="reset-color" href='https://klingt.net/privacy-policy.html'>Privacy Policy</a></li>
          
        </ul>
      </div>
    </details>
    <div>
      <span class="bold sm-margin-right">klingt.net</span>
      <img class="valign nav-icon invert-if-dark" alt="website logo" src="https://klingt.net/assets/logo.svg">
    </div>
  </div>
</nav>

      </header>
    </div>
    <div class="main">
      <main>
        
<h1>AMD Ryzen random reboots under Linux when in idle</h1>
<p>At the end of 2019 I decided to replace my, now 10 years old, trusty Intel i7 920 machine.
The main motivation was that the i7 was not powerful enough to drive a bunch of CPU hungry software synth, and I always wanted to have a machine that was able to handle any amount of audio plugins I throw at it.
It was still fast enough for some casual gaming or web browsing so I gave it to a friend who was looking for PC at that time.  Otherwise I would have had to throw it away, which would have made me feel a little guilty.
Anyways, AMD Ryzen was all the buzz at that time so I decided to go for that and ordered all the necessary parts.</p>
<p>Here are the relevant specs for reference:</p>
<ul>
<li>CPU: AMD Ryzen 3700X</li>
<li>Mainboard: ASUS ROG STRIX B450-I GAMING</li>
<li>Memory: 32GB Corsair DDR4 DRAM 3200MHz (part no. <code>CMK32GX4M2B3200C16</code>) <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
<li>OS: Arch Linux kernel 5.14.8-arch1-1</li>
</ul>
<p>Now to the actual topic of this post that is the random reboots that the Ryzen PC showed when running in idle for some time.
I ran a stress test over night and there was no spontaneous reboot so I could rule out a faulty power supply.
Checking <code>journalctl</code> for errors did not reveal anything suspicious <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>, in fact the logs just ended before the reboot without any error message.</p>
<p>There is a <a href="https://wiki.gentoo.org/wiki/Ryzen#Random_reboots_with_mce_events">Ryzen page on Gentoo's wiki</a> that recommends to set two kernel parameters:</p>
<ul>
<li><code>idle=nomwait</code></li>
<li>and <code>processor.max_cstate=5</code></li>
</ul>
<p>The latter one disables certain processor <a href="https://www.thomas-krenn.com/en/wiki/Processor_P-states_and_C-states#C-states">c-states</a> which are basically sleep levels a processor can reach when idling, where C0 is the active state and Cn is the <em>lowest level of activity</em> or <em>power consumption</em>.  Disabling c-states is actually wasting energy and thus not very desirable.  I then set both kernel parameters and tried the latest kernel and the LTS variant, but spontaneous reboots still occured.  For a moment I ran out of ideas and suspected that either my Ryzen CPU was defective.</p>
<p>A couple of weeks passed and after some UEFI update I had to reset BIOS settings to <em>optimized defaults</em>.  With default settings no random reboots happened anymore!  Problem solved?  Not yet.  In default settings memory is not running at full speed and Ryzen CPUs scale quite well with memory bandwidth.  Enabling the <a href="https://www.intel.com/content/www/us/en/gaming/extreme-memory-profile-xmp.html">XMP memory profile</a> is, except the a different boot order, the only thing I change from defaults.  This made me curious and after some googling I stumbled over a <a href="https://linustechtips.com/topic/1298348-ryzen-reboot-at-idle-solved-rma/">linustechtips forum thread</a> where someone suggested to disable memory <em>power down mode</em>.  Because BIOS settings are often undocumented I cannot exactly say what this settings does, except from the obviously disabling some memory power saving feature.  Anyways, this setting was located under <code>AI Tweaker -&gt; Memory Timing Controls</code> which is kind of hidden.</p>
<p>To make a long story short, disabling memory <em>power down mode</em> made the random reboots disappear, even when if the memory XMP profile is activated.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>dmidecode to the rescue, god knows which RAM I had installed: <code>$ sudo dmidecode --type memory | grep -i part</code>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><code>$ journalctl --priority 0..3 --boot=-1</code>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


      </main>
    </div>
    <div class="footer">
      <footer>
        
<p class="center">
  <a href="#">Back to top.</a>
</p>

      </footer>
    </div>
  </div>
</body>

</html>




